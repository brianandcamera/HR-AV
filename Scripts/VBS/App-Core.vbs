'HR-AV Desktop Antivirus
'https://github.com/zelon88/HR-AV
'https://github.com/zelon88

'Author: Justin Grimes
'Date: 8/23/2019
'<3 Open-Source

'Unless Otherwise Noted, The Code Contained In This Repository Is Licensed Under GNU GPLv3
'https://www.gnu.org/licenses/gpl-3.0.html

'Portions of the UI-Core.vbs file are licensed under the Microsoft Limited Public License.
'Copies of all applicable software licenses can be found in the "Documentation" directory.

'This file contains popular functions that are likely to be used throught the entire operation.
'Note that some of the real-time protection files define these variables again for robustness.

'--------------------------------------------------
Option Explicit

Dim php73Directory, phpavEngineDirectory, whoamiOutput, strHRAVpassword, storedPassword, configFile, colAccounts, objUser, _
 objUser2, objGroup, ouser, sCommLine, dProcess, cProcessList
'--------------------------------------------------

'--------------------------------------------------
phpavEngineDirectory = scriptsDirectory & "\PHP\PHP-AV\"
php73Directory = "PHP\7.3.8\php.exe"

'--------------------------------------------------

Function Die()
  For Each dProcess in cProcessList
    sCommLine = Trim(LCase(dProcess.CommandLine))
    If InStr(sCommLine, fullScriptName) = 0 Then
      dProcess.Terminate()
    End If
  Next
  Window.Close
End Function

'--------------------------------------------------
'A function to tell if the script has the required priviledges to run.
'Returns TRUE if the application is elevated as admin user.
'Returns FALSE if the application is not elevated as admin user.
Function isUserAdmin()
  On Error Resume Next
  CreateObject("WScript.Shell").RegRead("HKEY_USERS\S-1-5-19\Environment\TEMP")
  If Err.number = 0 Then 
    isUserAdmin = TRUE
  Else
    isUserAdmin = FALSE
  End If
  Err.Clear
End Function
'--------------------------------------------------

'--------------------------------------------------
'A function to restart the script with admin priviledges if required.
Function restartAsAdmin()
    oShell2.ShellExecute "wscript.exe", Chr(34) & fullScriptName & Chr(34), "", "runas", 1
End Function
'--------------------------------------------------

'--------------------------------------------------
'A function to tell if the script has the required priviledges to run.
'Returns TRUE if the application is elevated as HRAV user.
'Returns FALSE if the application is not elevated as HRAV user.
Function isUserHRAV()
  On Error Resume Next
  whoamiOutput = SystemBootstrap ("whoami", "", FALSE)
  CreateObject("WScript.Shell").RegRead("HKEY_USERS\S-1-5-19\Environment\TEMP")
  If Err.number = 0 And whoamiOutput = strHRAVUserName Then 
    isUserHRAV = TRUE
  Else
    isUserHRAV = FALSE
  End If
  Err.Clear
End Function
'--------------------------------------------------

'--------------------------------------------------
'A function to restart the script with admin priviledges if required.
Function restartAsHRAV(password)
    Bootstrap "PAExec\paexec.exe", "-u:" & strHRAVUserName & " -p:" & strHRAVPassword & " " & fullScriptName, FALSE
End Function
'--------------------------------------------------

'--------------------------------------------------
'A function to create a log file.
Function createLog(strEventInfo)
  If Not strEventInfo = "" Then
    Set objLogFile = oFSO.CreateTextFile(logFileName, True)
    objLogFile.WriteLine(strEventInfo)
    objLogFile.Close
  End If
End Function
'--------------------------------------------------

'--------------------------------------------------
'A function to create a Warning.mail file. Use to prepare an email before calling sendEmail().
Function createEmail()
  If oFSO.FileExists(mailFile) Then
    oFSO.DeleteFile(mailFile)
  End If
  If Not oFSO.FileExists(mailFile) Then
    oFSO.CreateTextFile(mailFile)
  End If
  Set oFile = oFSO.CreateTextFile(mailFile, True)
  oFile.Write "To: " & toEmail & vbNewLine & "From: " & strComputerName & "@" & companyDomain & vbNewLine & _
   "Subject: " & companyAbbr & " HRAV Warning!!!" & vbNewLine & _
   "This is an automatic email from the " & companyName & " Network to notify you that a workstation was disabled to prevent potential ransomware activity." & _
   vbNewLine & vbNewLine & "Please log-in and verify that the equipment listed below is secure." & vbNewLine & _
   vbNewLine & "USER NAME: " & strUserName & vbNewLine & "WORKSTATION: " & strComputerName & vbNewLine & _
   "This check was generated by " & strComputerName & "."
  oFile.close
End Function
'--------------------------------------------------

'--------------------------------------------------
'A function for running SendMail to send a prepared Warning.mail email message.
Function sendEmail() 
  oShell.run "c:\Windows\System32\cmd.exe /c sendmail.exe " & mailFile, 0, TRUE
End Function
'--------------------------------------------------

'--------------------------------------------------
Function generatePassword()

End Function
'--------------------------------------------------

'--------------------------------------------------
Function verifyPassword()

End Function
'--------------------------------------------------

Function checkHRAVUser()
  On Error Resume Next
  Set ouser = GetObject("WinNT://" & strComputerName & "/" & strHRAVUserName & ",user")
  checkHRAVUser = FALSE
  If Err.number = 0 Then
    checkHRAVUser = TRUE
  End If
  Err.clear
End Function

'--------------------------------------------------
Function createHRAVUser()
  createHRAVUser = FALSE
  'Creation of the local user
  Set colAccounts = GetObject("WinNT://" & strComputerName & "")
  Set objGroup = GetObject("WinNT://" & strComputerName & "/Administrators,group") 
  Set objUser2 = GetObject("WinNT://" & strComputerName & "/" & strHRAVUserName & ",user")
  Set objUser = colAccounts.Create("user", strHRAVUserName)  
  objUser.SetPassword generatePassword()
  objUser.SetInfo
  ' Select the option "Password never expire"
  Const ADS_UF_DONT_EXPIRE_PASSWD = &h10000
  objUserFlags = objUser.Get("UserFlags")
  objPasswordExpirationFlag = objUserFlags OR ADS_UF_DONT_EXPIRE_PASSWD
  objUser.Put "userFlags", objPasswordExpirationFlag 
  objUser.SetInfo
  'Add the newly created HRAV user to the Administrators group.
  On Error Resume Next 
  objGroup.Add(objUser2.ADsPath) 
  Err.clear
  createHRAVUser = checkHRAVUser()
End Function

'--------------------------------------------------
Function verifyInstallation()
  verifyInstallation = FALSE
  createUserCheck = FALSE
  If checkHRAVUser = FALSE Then
    createUserCheck = createHRAVUser()
    MsgBox "There was a problem creating the HRAV user! This is usually because you do not have administrator permissions. Real-time protection"
  End If
End Function
'--------------------------------------------------

'--------------------------------------------------
'A function shut down the machine when triggered.
Function killWorkstation()
     oShell.Run "C:\Windows\System32\shutdown.exe /s /f /t 0", 0, false
End Function
'--------------------------------------------------



